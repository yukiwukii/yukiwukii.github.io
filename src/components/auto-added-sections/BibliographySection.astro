---
import type { Citation } from "@/lib/interfaces";
import { getSymbolForLinkedContent } from "@/utils";
import { BIBLIOGRAPHY_STYLE } from "@/constants";
import NBlocksPopover from "@/components/popover/NBlocksPopover.astro";

export interface Props {
	citations: Citation[];
}

const { citations } = Astro.props;

// Bibliography should already be sorted by prepareBibliography()
// IEEE: By Index (first appearance order)
// APA: Alphabetically by Authors
---

{
	citations.length > 0 && (
		<section class="bibliography-section auto-imported-section">
			<hr class="divider" />
			<h2 class="non-toggle-h2 hasId" id="autogenerated-bibliography">
				Bibliography
			</h2>
			{/* IEEE: numbered list (1, 2, 3...) | APA: no markers (plain entries) */}
			<ol
				class:list={[
					"bibliography-list",
					{ "bibliography-ieee": BIBLIOGRAPHY_STYLE === "simplified-ieee" },
				]}
			>
				{citations.map((citation) => (
					<li id={`citation-def-${citation.Key}`} class="relative">
						{/* Back to citation button (hidden by default, shown via script) - positioned in left margin */}
						<button
							data-back-to-citation
							data-citation-key={citation.Key}
							class="citation-back-btn group"
							aria-label="Back to citation"
						>
							<svg
								class="text-accent group-hover:text-accent-2 h-3 w-3"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M5 10l7-7m0 0l7 7m-7-7v18"
								/>
							</svg>
						</button>

						<div class="citation-entry">
							{/* Formatted bibliography entry */}
							{citation.Url ? (
								<a
									href={citation.Url}
									target="_blank"
									rel="noopener noreferrer"
									class="text-link site-page-link decoration-solid"
								>
									<span set:html={citation.FormattedEntry} />
								</a>
							) : (
								<span set:html={citation.FormattedEntry} />
							)}

							{/* Backlinks with symbols using NBlocksPopover */}
							{citation.SourceBlocks && citation.SourceBlocks.length > 0 && (
								<span class="citation-backlinks">
									<span class="text-gray-500 dark:text-gray-400">at</span>{" "}
									{citation.SourceBlocks.map((block, index) => (
										<NBlocksPopover
											block={block}
											linkedTo={`#${block.Id}`}
											popoverSpanText={`[${getSymbolForLinkedContent(index)}]`}
											linkText="Jump to"
											isInterlinkedBack={true}
										/>
									))}
								</span>
							)}
						</div>
					</li>
				))}
			</ol>
		</section>
	)
}
