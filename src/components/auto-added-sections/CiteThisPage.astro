---
import type { Post, AuthorProperty } from "@/lib/interfaces";
import { siteInfo } from "@/siteInfo";
import { getPostLink, isExternalPost } from "@/lib/blog-helpers";
import { MENU_PAGES_COLLECTION } from "@/constants";
import Icon from "@/components/ui/Icon.astro";

export interface Props {
	post: Post;
}

const { post } = Astro.props;
const shouldRender = !isExternalPost(post);

// Extract year and month from post date
const postDate = new Date(post.Date);
const year = postDate.getFullYear();
const monthNames = [
	"Jan",
	"Feb",
	"Mar",
	"Apr",
	"May",
	"Jun",
	"Jul",
	"Aug",
	"Sep",
	"Oct",
	"Nov",
	"Dec",
];
const month = monthNames[postDate.getMonth()];

// Format author name for BibTeX (Lastname, Firstname Middlename)
// Input: "Firstname Middlename Lastname" or "Firstname Lastname"
// Output: "Lastname, Firstname Middlename" or "Lastname, Firstname"
const formatAuthorName = (name: string): string => {
	if (!name || name === "Unknown Author") return "Unknown Author";

	const parts = name.trim().split(/\s+/);
	if (parts.length === 1) {
		// Single name, just return as-is
		return parts[0];
	} else if (parts.length === 2) {
		// Firstname Lastname -> Lastname, Firstname
		return `${parts[1]}, ${parts[0]}`;
	} else {
		// Firstname Middlename(s) Lastname -> Lastname, Firstname Middlename(s)
		const lastname = parts[parts.length - 1];
		const firstAndMiddle = parts.slice(0, -1).join(" ");
		return `${lastname}, ${firstAndMiddle}`;
	}
};

// Get authors list - use post.Authors if available, otherwise fallback to site author
const getAuthors = (): string[] => {
	if (post.Authors && post.Authors.length > 0) {
		return post.Authors.map((a) => a.name);
	}
	if (siteInfo.author) {
		return [siteInfo.author];
	}
	return ["Unknown Author"];
};

const authors = getAuthors();
const authorFormatted = authors.map(formatAuthorName).join(" and ");

// Generate citation key in format: lastnameyearfirstNofslug (e.g., "yan2024aligneval")
const getLastname = (name: string): string => {
	if (!name || name === "Unknown Author") return "unknown";
	const parts = name.trim().split(/\s+/);
	return parts[parts.length - 1].toLowerCase();
};

const lastname = getLastname(authors[0] || "Unknown Author");
const slugClean = post.Slug.replace(/[-_]/g, "");
const slugShort = slugClean.substring(0, Math.min(15, slugClean.length)); // Use first 15 chars max
const citationKey = `${lastname}${year}${slugShort}`;

// Build full URL using Astro.site and getPostLink
// Astro.site is the canonical site URL from astro.config
const isPage = post.Collection === MENU_PAGES_COLLECTION;
const postPath = getPostLink(post.Slug, isPage);
const fullUrl = Astro.site ? new URL(postPath, Astro.site).toString() : postPath;
const decodedUrl = decodeURIComponent(fullUrl);

// Extract journal name from site URL (e.g., "eugeneyan.com" from "https://eugeneyan.com")
const journal = Astro.site ? new URL(Astro.site).hostname : "unknown";

// Create BibTeX entry in @article format
const bibtexEntry = `@article{${citationKey},
  title   = {${post.Title}},
  author  = {${authorFormatted}},
  journal = {${journal}},
  year    = {${year}},
  month   = {${month}},
  url     = {${decodedUrl}}
}`;
---

{
	shouldRender && (
		<section class="cite-this-page-section auto-imported-section" data-pagefind-ignore="all">
			<hr class="divider" />
			<h2 class="non-toggle-h2 hasId" id="autogenerated-cite-this-page">
				Cite This Page
			</h2>

			<div class="code group relative z-0 mb-1 w-full max-w-full text-sm">
				<div class="max-h-[340px] min-w-0 overflow-scroll print:max-h-full">
					<div class="flex max-w-full">
						<button data-code={bibtexEntry} aria-label="copy citation">
							<Icon
								class="copy-icon-before h-6 w-6"
								name={"clipboard-copy-code"}
								aria-label="copy citation"
							/>
							<Icon
								class="copy-icon-done hidden h-6 w-6"
								name={"clipboard-copy-code-done"}
								aria-label="copied citation"
							/>
						</button>
					</div>
					<!-- prettier-ignore -->
					<pre class="overflow-x-auto rounded-sm bg-gray-100 p-4 font-mono text-sm dark:bg-gray-800"><code>{bibtexEntry}</code></pre>
				</div>
			</div>
		</section>
	)
}
