---
import type { Footnote } from "@/lib/interfaces";
import { numberToAlphabet } from "@/utils";
import NBlocksPopover from "@/components/popover/NBlocksPopover.astro";
import FootnoteContent from "@/components/notion-blocks/FootnoteContent.astro";
import { adjustedFootnotesConfig } from "@/lib/notion/client";

export interface Props {
	footnotes: Footnote[];
}

const { footnotes } = Astro.props;

// Remove duplicates based on Marker (in case same footnote appears multiple times)
const uniqueFootnotes = Array.from(new Map(footnotes.map((fn) => [fn.Marker, fn])).values());

// Sort by Index (sequential numbering) if available, otherwise by Marker
uniqueFootnotes.sort((a, b) => {
	if (a.Index && b.Index) {
		return a.Index - b.Index;
	}
	return a.Marker.localeCompare(b.Marker);
});

// Check if start-of-child-blocks is enabled (no spacing needed for block-type footnotes)
const isStartOfChildBlocks =
	adjustedFootnotesConfig?.["in-page-footnotes-settings"]?.source?.["start-of-child-blocks"] ===
	true;
---

{
	uniqueFootnotes.length > 0 && (
		<section class="footnotes-section auto-imported-section">
			<hr class="divider" />
			<h2 class="non-toggle-h2 hasId" id="autogenerated-footnotes">
				Footnotes
			</h2>
			<ol class:list={["list-none", { "space-y-2": !isStartOfChildBlocks }]}>
				{uniqueFootnotes.map((footnote) => (
					<li id={`footnote-def-${footnote.Marker}`} class="flex items-baseline gap-2">
						{footnote.SourceBlock ? (
							<NBlocksPopover
								block={footnote.SourceBlock}
								linkedTo={`#${footnote.SourceBlockId}`}
								popoverSpanText={`[${numberToAlphabet(footnote.Index) || footnote.Marker}]`}
								linkText="Jump to"
								isInterlinkedBack={true}
							/>
						) : (
							<span class="text-accent-2/60 shrink-0 font-mono text-sm">
								[{numberToAlphabet(footnote.Index) || footnote.Marker}]
							</span>
						)}
						<div class="flex-1">
							<FootnoteContent content={footnote.Content} sourceBlockId={footnote.SourceBlockId} />
						</div>
					</li>
				))}
			</ol>
		</section>
	)
}
