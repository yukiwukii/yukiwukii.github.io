---
import { INTERLINKED_CONTENT, BUILD_FOLDER_PATHS } from "@/constants";
import InternalLinksInThisPage from "@/components/auto-added-sections/interlinked-content/SiteLinksInThisPage.astro";
import LinksToThisPage from "@/components/auto-added-sections/interlinked-content/LinksToThisPage.astro";
import ExternalLinksInThisPage from "@/components/auto-added-sections/interlinked-content/ExternalLinksInThisPage.astro";
import MediaLinksInThisPage from "@/components/auto-added-sections/interlinked-content/MediaLinksInThisPage.astro";
import type { Post } from "@/lib/interfaces";
import { getInterlinkedContentInPage, getInterlinkedContentToPage } from "@/lib/blog-helpers";
import * as fs from "fs/promises";
import * as path from "path";

interface Props {
	post: Post;
	shouldUseCache: boolean;
}

const { post, shouldUseCache } = Astro.props;
// Load interlinked content data
const allInterlinkedContentToPage = getInterlinkedContentToPage(post.PageId);
const allInterlinkedContentInPage = getInterlinkedContentInPage(post.PageId);

// Filter interlinked content for each component
const filteredExternalNonMediaInterlinkedContent = allInterlinkedContentInPage
	? allInterlinkedContentInPage.filter(
			(ref) => ref.external_hrefs.length > 0 || ref.direct_nonmedia_link,
		)
	: null;
const filteredSitePages = allInterlinkedContentInPage
	? allInterlinkedContentInPage.filter((ref) => ref.other_pages.length > 0 || ref.link_to_pageid)
	: null;
const filteredMediaInterlinkedContent = allInterlinkedContentInPage
	? allInterlinkedContentInPage.filter((ref) => ref.direct_media_link)
	: null;

// Determine if rendering is needed
const rendering =
	INTERLINKED_CONTENT &&
	Object.keys(INTERLINKED_CONTENT).length > 0 &&
	((INTERLINKED_CONTENT["links-to-this-page"] &&
		allInterlinkedContentToPage &&
		Object.keys(allInterlinkedContentToPage).length > 0) ||
		(INTERLINKED_CONTENT["site-links-in-page"] &&
			filteredSitePages &&
			Object.keys(filteredSitePages).length > 0) ||
		(INTERLINKED_CONTENT["external-links-in-page"] &&
			filteredExternalNonMediaInterlinkedContent &&
			Object.keys(filteredExternalNonMediaInterlinkedContent).length > 0) ||
		(INTERLINKED_CONTENT["media-and-file-links-in-this-page"] &&
			filteredMediaInterlinkedContent &&
			Object.keys(filteredMediaInterlinkedContent).length > 0));

// Load cached HTML if shouldUseCache is true
let cachedStaticInterlinkedContentHtml = null;
const staticCachePath = path.join(
	BUILD_FOLDER_PATHS["interlinkedContentHtmlCache"],
	`${post.Slug}-static.html`,
);

if (shouldUseCache) {
	try {
		cachedStaticInterlinkedContentHtml = await fs.readFile(staticCachePath, "utf-8");
	} catch {
		cachedStaticInterlinkedContentHtml = null;
	}
}
---

<aside data-pagefind-ignore="all" class="auto-imported-section print:hidden">
	{
		rendering && (
			<>
				<h2 class="non-toggle-h2 hasId" id="autogenerated-interlinked-content">
					Interlinked Content
				</h2>
			</>
		)
	}

	{
		INTERLINKED_CONTENT &&
			Object.keys(INTERLINKED_CONTENT).length > 0 &&
			INTERLINKED_CONTENT["links-to-this-page"] &&
			allInterlinkedContentToPage && (
				<LinksToThisPage post={post} allInterlinkedContentToPage={allInterlinkedContentToPage} />
			)
	}

	{
		INTERLINKED_CONTENT &&
			Object.keys(INTERLINKED_CONTENT).length > 0 &&
			(INTERLINKED_CONTENT["site-links-in-page"] ||
				INTERLINKED_CONTENT["media-and-file-links-in-this-page"] ||
				INTERLINKED_CONTENT["external-links-in-page"]) &&
			(filteredSitePages ||
				filteredMediaInterlinkedContent ||
				filteredExternalNonMediaInterlinkedContent) &&
			(cachedStaticInterlinkedContentHtml ? (
				<div class="static-interlinked-content" set:html={cachedStaticInterlinkedContentHtml} />
			) : (
				<div class="static-interlinked-content">
					{INTERLINKED_CONTENT["site-links-in-page"] && filteredSitePages && (
						<InternalLinksInThisPage
							post={post}
							filteredInterlinkedContentInPage={filteredSitePages}
						/>
					)}
					{INTERLINKED_CONTENT["media-and-file-links-in-this-page"] &&
						filteredMediaInterlinkedContent && (
							<MediaLinksInThisPage
								post={post}
								filteredInterlinkedContentInPage={filteredMediaInterlinkedContent}
							/>
						)}
					{INTERLINKED_CONTENT["external-links-in-page"] &&
						filteredExternalNonMediaInterlinkedContent && (
							<ExternalLinksInThisPage
								post={post}
								filteredInterlinkedContentInPage={filteredExternalNonMediaInterlinkedContent}
							/>
						)}
				</div>
			))
	}

	{rendering && <hr class="divider" />}
</aside>
