---
// Heavy inspiration taken from Astro Starlight -> https://github.com/withastro/starlight/blob/main/packages/starlight/components/Search.astro

import Icon from "@/components/ui/Icon.astro";
---

<site-search id="search" class="ms-auto">
	<button data-open-modal disabled class="search-btn" aria-label="Open search">
		<Icon class="h-7 w-7" name={"search"} />
	</button>
	<dialog aria-label="search" class="search-dialog">
		<div class="search-frame">
			<button data-close-modal class="search-close-btn" aria-label="Close Search"
				><Icon class="inline h-6 w-6" name={"close"} aria-hidden="true" focusable="false" /></button
			>
			{
				import.meta.env.DEV ? (
					<div class="mx-auto text-center">
						<p>
							Search is only available in production builds. <br />
							Try building and previewing the site to test it out locally.
						</p>
					</div>
				) : (
					<div class="search-container">
						<div id="webtrotion__search" />
					</div>
				)
			}
		</div>
	</dialog>
</site-search>

<script>
	class SiteSearch extends HTMLElement {
		private openBtn: HTMLButtonElement;
		private closeBtn: HTMLButtonElement;
		private dialog: HTMLDialogElement;
		private dialogFrame: HTMLDivElement;
		private observer: MutationObserver;
		private initialized: boolean = false;
		private idleCallbackId: number | null = null;
		private pagefindUI: any = null;
		private _loadPagefind: (() => Promise<void>) | null = null;

		constructor() {
			super();
			this.openBtn = this.querySelector<HTMLButtonElement>("button[data-open-modal]")!;
			this.closeBtn = this.querySelector<HTMLButtonElement>("button[data-close-modal]")!;
			this.dialog = this.querySelector("dialog")!;
			this.dialogFrame = this.querySelector(".search-frame")!;

			this.openBtn.addEventListener("click", this.openModal);
			this.openBtn.disabled = false;
			this.closeBtn.addEventListener("click", this.closeModal);

			// Initialize MutationObserver
			this.observer = new MutationObserver(this.queueDOMCheck);
		}

		connectedCallback() {
			window.addEventListener("keydown", this.onWindowKeydown);
			if (import.meta.env.DEV) return;

			this._loadPagefind = async () => {
				if (this.pagefindUI) return;
				const { PagefindUI } = await import("@pagefind/default-ui");
				const bundlePath = import.meta.env.BASE_URL.replace(/\/$/, "") + "/pagefind/";
				const css = document.createElement("link");
				css.rel = "stylesheet";
				css.href = bundlePath + "pagefind-ui.css";
				document.head.appendChild(css);

				this.pagefindUI = new PagefindUI({
					element: "#webtrotion__search",
					baseUrl: import.meta.env.BASE_URL,
					bundlePath: import.meta.env.BASE_URL.replace(/\/$/, "") + "/pagefind/",
					showImages: false,
					showSubResults: true,
					showEmptyFilters: false,
					openFilters: ["Tags"],
					translations: {
						placeholder: "Tip: Use âŒ˜K or ^K to open search",
						zero_results: "Couldn't find [SEARCH_TERM]",
					},
				});

				if (this.dialog.open) {
					requestAnimationFrame(() => this.querySelector("input")?.focus());
				}

				// Start observing the dialog for changes
				this.observer.observe(this.dialog, { childList: true, subtree: true });

				const queryParams = new URLSearchParams(window.location.search);
				const searchTerm = queryParams.get("q");

				if (searchTerm) {
					this.openModal();
					this.pagefindUI.triggerSearch(searchTerm);
				}
			};

			const queryParams = new URLSearchParams(window.location.search);
			if (queryParams.get("q")) {
				this._loadPagefind();
			} else {
				// Load on interaction
				this.openBtn.addEventListener("mouseenter", () => this._loadPagefind?.(), { once: true });
				this.openBtn.addEventListener("focus", () => this._loadPagefind?.(), { once: true });
			}
		}

		disconnectedCallback() {
			window.removeEventListener("keydown", this.onWindowKeydown);
			this.observer.disconnect();
			if (this.idleCallbackId !== null) {
				(window.cancelIdleCallback || clearTimeout)(this.idleCallbackId);
			}
		}

		queueDOMCheck = () => {
			if (this.initialized) return;

			if (this.idleCallbackId !== null) {
				(window.cancelIdleCallback || clearTimeout)(this.idleCallbackId);
			}

			const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
			this.idleCallbackId = onIdle(this.checkForFilterBlocks);
		};

		checkForFilterBlocks = () => {
			this.idleCallbackId = null;
			if (this.initialized) return;

			const filterBlocks = this.dialog.querySelectorAll(".pagefind-ui__filter-block");
			if (filterBlocks.length >= 2) {
				this.initializeFilterBlocks(filterBlocks);
				this.initialized = true;
				this.observer.disconnect();
			}
		};

		initializeFilterBlocks = (filterBlocks: NodeListOf<Element>) => {
			const secondFilterBlock = filterBlocks[1] as HTMLDetailsElement;
			if (window.innerWidth >= 640) {
				// Tailwind's sm breakpoint
				secondFilterBlock.setAttribute("open", "");
			} else {
				secondFilterBlock.removeAttribute("open");
			}
		};

		onWindowClick = (event: MouseEvent) => {
			const isLink = "href" in (event.target || {});
			if (
				isLink ||
				(document.body.contains(event.target as Node) &&
					!this.dialogFrame.contains(event.target as Node))
			)
				this.closeModal();
		};

		onWindowKeydown = (e: KeyboardEvent) => {
			if ((e.metaKey || e.ctrlKey) && e.key === "k" && !this.dialog.open) {
				this.openModal();
				e.preventDefault();
			}
		};

		openModal = (event?: MouseEvent) => {
			if (!this.pagefindUI) {
				this._loadPagefind?.();
			}
			this.dialog.showModal();
			this.querySelector("input")?.focus();
			event?.stopPropagation();
			window.addEventListener("click", this.onWindowClick);
		};

		closeModal = () => {
			if (this.dialog.open) {
				this.dialog.close();
				window.removeEventListener("click", this.onWindowClick);
			}
		};
	}

	customElements.define("site-search", SiteSearch);
</script>
