---
import type { RichText, Block, Citation } from "@/lib/interfaces";
import { BIBLIOGRAPHY_STYLE, CITATIONS, BIBTEX_CITATIONS_ENABLED } from "@/constants";
import { adjustedFootnotesConfig } from "@/lib/notion/client";

export interface Props {
	richText: RichText;
	blockID: string;
	block: Block;
}

const { richText, blockID, block } = Astro.props;

// Get the citation key reference (e.g., "smith2020")
const citationRef = richText.CitationRef;

// Find the corresponding citation in block.Citations
let citation: Citation | undefined = undefined;
if (block.Citations && citationRef) {
	citation = block.Citations.find((c) => c.Key === citationRef);
}

// Generate unique ID for this citation marker (using random component to avoid duplicates when same content appears multiple times)
const uniqueId = `citation-${Math.random().toString(16).slice(2)}-${block.Id}-${citationRef}`;

// Determine what to display:
// - IEEE: [1], [2], etc. (using Index)
// - APA: (Author et al, Year)
let displayText = "";

if (citation) {
	if (BIBLIOGRAPHY_STYLE === "simplified-ieee" && citation.Index) {
		// IEEE: Show numbers
		displayText = `[${citation.Index}]`;
	} else {
		// APA style: Show author/year
		displayText = `(${citation.Authors}, ${citation.Year})`;
	}
} else {
	displayText = `[?]`;
}

// Check if bibliography section is being generated
const showBibliography =
	BIBTEX_CITATIONS_ENABLED &&
	CITATIONS?.["extract-and-process-bibtex-citations"]?.["generate-bibliography-section"] === true;

// Determine if citation should show in margin
const footnoteMargin =
	adjustedFootnotesConfig?.["in-page-footnotes-settings"]?.["show-in-margin-on-large-screens"] ===
	true;
const citationMargin =
	CITATIONS?.["extract-and-process-bibtex-citations"]?.["show-in-margin-on-large-screens"] === true;

const shouldShowInMargin = (() => {
	if (!citation) return false; // Broken citation → no margin
	if (!citationMargin) return false; // Citation margin disabled → always popover

	// When both margins are enabled: show first occurrence anywhere
	if (footnoteMargin) {
		if (!citation.FirstAppearanceIndex) return false; // Not first occurrence globally → popover
		return true; // First occurrence (anywhere) → margin
	}

	// When footnote margin is disabled but citation margin is enabled:
	// Only show first occurrence in main content (not first in footnote)
	if (!footnoteMargin && !citation.FirstAppearanceInMainContentIndex) return false; // Not first in main content → popover
	return true; // First occurrence in main content → margin
})();
---

{/* If no citation content found, render as muted text (broken reference) */}
{
	!citation ? (
		<span class="citation-marker-broken text-textColor/70" title="Citation not found">
			{richText.PlainText}
		</span>
	) : (
		<>
			{/* Render citation marker with appropriate attributes for popover or margin mode */}
			{shouldShowInMargin ? (
				<span class="decoration-quote/40 underline decoration-dotted underline-offset-2">
					<span
						data-margin-note={uniqueId}
						data-citation-key={citation.Key}
						data-popover-target={`popover-description-${uniqueId}`}
						data-popover-placement="bottom-end"
						class="text-quote cursor-pointer font-mono text-xs"
						aria-label="Show information for the linked content"
					>
						{displayText}
					</span>
				</span>
			) : (
				<span class="decoration-quote/40 underline decoration-dotted underline-offset-2">
					<span
						data-popover-target={`popover-description-${uniqueId}`}
						data-citation-key={citation.Key}
						data-popover-placement="bottom-end"
						class="text-quote cursor-pointer font-mono text-xs"
						aria-label="Show information for the linked content"
					>
						{displayText}
					</span>
				</span>
			)}

			{/* Template for popover content */}
			<template id={`template-popover-description-${uniqueId}`}>
				<div
					data-popover
					id={`popover-description-${uniqueId}`}
					data-source-block-id={blockID}
					data-citation-key={citation.Key}
					role="tooltip"
					class="popoverEl border-accent-2/20 bg-popover-bg/95 text-textColor/80 invisible absolute z-40 hidden inline-block w-72 rounded-lg border text-sm opacity-0 shadow-xs backdrop-blur-sm transition-opacity duration-300"
				>
					<div class="space-y-2 p-2">
						{citation.Url ? (
							<a
								href={citation.Url}
								target="_blank"
								rel="noopener noreferrer"
								class="text-link site-page-link decoration-solid"
							>
								<div class="citation-content" set:html={citation.FormattedEntry} />
							</a>
						) : (
							<div class="citation-content" set:html={citation.FormattedEntry} />
						)}
						{showBibliography && (
							<div class="jump-to-bibliography pt-2">
								<a
									href={`#citation-def-${citation.Key}`}
									data-popover-link
									class="text-link/90 flex max-w-full items-center font-medium hover:underline"
									onclick={`
										event.preventDefault();

										// Clear any previously active back buttons
										document.querySelectorAll('li[data-show-back-button]').forEach(li => {
											delete li.dataset.showBackButton;
											delete li.dataset.backToBlock;
										});

										// Set active on target
										const target = document.getElementById('citation-def-${citation.Key}');
										if (target) {
											target.dataset.showBackButton = 'true';
											target.dataset.backToBlock = '${blockID}';
										}

										window.location.hash = '#citation-def-${citation.Key}';
										target?.scrollIntoView({ behavior: 'smooth' });
									`}
								>
									{"Jump to bibliography"}
									<svg
										class="text-accent group-hover:text-accent-2 ms-1.5 h-2 w-2 rtl:rotate-180"
										aria-hidden="true"
										xmlns="http://www.w3.org/2000/svg"
										fill="none"
										viewBox="0 0 6 10"
									>
										<path
											stroke="currentColor"
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="m1 9 4-4-4-4"
										/>
									</svg>
								</a>
							</div>
						)}
					</div>
				</div>
			</template>

			{/* Template for margin notes content (same structure, used by margin notes script) */}
			{shouldShowInMargin && (
				<template id={`template-margin-${uniqueId}`}>
					<div class="text-sm!">
						<span class="text-quote font-mono text-xs!">{displayText}</span>{" "}
						{citation.Url ? (
							<a
								href={citation.Url}
								target="_blank"
								rel="noopener noreferrer"
								class="text-link site-page-link decoration-solid"
							>
								<span class="citation-content" set:html={citation.FormattedEntry} />
							</a>
						) : (
							<span class="citation-content" set:html={citation.FormattedEntry} />
						)}
						{showBibliography && (
							<a
								href={`#citation-def-${citation.Key}`}
								class="text-link/90 ml-1 inline-block align-middle hover:underline"
								onclick={`
									event.preventDefault();

									// Clear any previously active back buttons
									document.querySelectorAll('li[data-show-back-button]').forEach(li => {
										delete li.dataset.showBackButton;
										delete li.dataset.backToBlock;
									});

									// Set active on target
									const target = document.getElementById('citation-def-${citation.Key}');
									if (target) {
										target.dataset.showBackButton = 'true';
										target.dataset.backToBlock = '${blockID}';
									}

									window.location.hash = '#citation-def-${citation.Key}';
									target?.scrollIntoView({ behavior: 'smooth' });
								`}
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="12"
									height="12"
									viewBox="0 0 24 24"
									class="inline-block"
								>
									<path
										fill="currentColor"
										d="M22 4V2H2v2h9v14.17l-5.5-5.5l-1.42 1.41L12 22l7.92-7.92l-1.42-1.41l-5.5 5.5V4z"
									/>
								</svg>
							</a>
						)}
					</div>
				</template>
			)}
		</>
	)
}
