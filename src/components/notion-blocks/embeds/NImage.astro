---
import { Image, getImage, inferRemoteSize } from "astro:assets";
import { ENABLE_LIGHTBOX, OPTIMIZE_IMAGES } from "@/constants.ts";
import * as interfaces from "@/lib/interfaces.ts";
import {
	getFirstImage,
	getNotionImage,
	getImageComponentFormat,
	filePath,
} from "@/lib/blog-helpers";
import Caption from "@/components/notion-blocks/Caption.astro";
import { isImageTypeForAstro } from "@/lib/notion/client";
import { joinPlainText } from "@/utils/richtext-utils";

export interface Props {
	block: interfaces.Block;
	setId?: boolean;
}

const { block, setId = true } = Astro.props;

let externalImageUrl = "";
let downloadedImage = null;
let lightboxImageUrl = null;

if (block.NImage?.External) {
	externalImageUrl = block.NImage.External.Url;
} else if (block.NImage?.File && !isImageTypeForAstro(block.NImage.File.Url)) {
	externalImageUrl = filePath(new URL(block.NImage.File.Url));
} else if (block.NImage?.File) {
	downloadedImage = await getNotionImage(new URL(block.NImage.File.Url));
}

// Generate optimized image for lightbox (only if OPTIMIZE_IMAGES is enabled)
if (downloadedImage && OPTIMIZE_IMAGES) {
	const optimizedImage = await getImage({
		src: downloadedImage,
		format: getImageComponentFormat(downloadedImage),
		quality: 85,
		width: downloadedImage.width, // Use original width to match the <Image> component
	});
	lightboxImageUrl = optimizedImage.src;
} else if (downloadedImage) {
	lightboxImageUrl = downloadedImage.src; // Fallback to original if not optimizing
}

// Infer size for external images to prevent CLS
let externalImageDimensions = null;
if (externalImageUrl && !block.NImage?.File) {
	try {
		externalImageDimensions = await inferRemoteSize(externalImageUrl);
	} catch (err) {
		console.warn(`Could not infer size for external image: ${externalImageUrl}`);
	}
}

const plainTextCaption = joinPlainText(block.NImage?.Caption || []);
const altText =
	plainTextCaption ||
	(downloadedImage ? "Image uploaded to Notion" : externalImageUrl ? "External image" : "Image");

const isFirstImage = getFirstImage() && setId;

// Generate a mobile-friendly width (~1200px) plus the original; avoid upscaling smaller files.
const mobileWidth = downloadedImage && downloadedImage.width > 1200 ? 1200 : downloadedImage?.width;
const imageWidths =
	downloadedImage && downloadedImage.width > 1200
		? [mobileWidth, downloadedImage.width]
		: downloadedImage
			? [downloadedImage.width]
			: undefined;
const imageSizes =
	downloadedImage && downloadedImage.width > 1200
		? `(max-width: 640px) 100vw, ${downloadedImage.width}px`
		: downloadedImage
			? `${downloadedImage.width}px`
			: undefined;
---

{
	(downloadedImage || externalImageUrl) && (
		<figure class="notion-image-figure" id={setId ? block.Id : undefined}>
			<div class="notion-image-container">
				{ENABLE_LIGHTBOX ? (
					<a
						data-type="image"
						href={downloadedImage ? lightboxImageUrl : externalImageUrl}
						class="mediaglightbox no-rss"
						data-description={plainTextCaption}
						aria-label={`Open image with alt ${plainTextCaption} in lightbox`}
					>
						{downloadedImage ? (
							<Image
								src={downloadedImage}
								alt={altText}
								priority={isFirstImage}
								loading={isFirstImage ? undefined : "lazy"}
								decoding={isFirstImage ? undefined : "async"}
								quality={OPTIMIZE_IMAGES ? 85 : undefined}
								widths={imageWidths}
								sizes={imageSizes}
								class="imagemedia notion-image"
								format={
									OPTIMIZE_IMAGES
										? getImageComponentFormat(downloadedImage)
										: downloadedImage.format
								}
							/>
						) : (
							<img
								class="imagemedia notion-image"
								loading={isFirstImage ? "eager" : "lazy"}
								decoding={isFirstImage ? "sync" : "async"}
								fetchpriority={isFirstImage ? "high" : undefined}
								src={externalImageUrl}
								alt={altText}
								width={externalImageDimensions ? externalImageDimensions.width : undefined}
								height={externalImageDimensions ? externalImageDimensions.height : undefined}
							/>
						)}
					</a>
				) : downloadedImage ? (
					<Image
						src={downloadedImage}
						alt={altText}
						priority={isFirstImage}
						loading={isFirstImage ? undefined : "lazy"}
						decoding={isFirstImage ? undefined : "async"}
						quality={OPTIMIZE_IMAGES ? 85 : undefined}
						widths={imageWidths}
						sizes={imageSizes}
						class="imagemedia notion-image"
						format={
							OPTIMIZE_IMAGES ? getImageComponentFormat(downloadedImage) : downloadedImage.format
						}
					/>
				) : (
					<img
						class="imagemedia notion-image"
						src={externalImageUrl}
						loading={isFirstImage ? "eager" : "lazy"}
						decoding={isFirstImage ? "sync" : "async"}
						fetchpriority={isFirstImage ? "high" : undefined}
						alt={altText}
						width={externalImageDimensions ? externalImageDimensions.width : undefined}
						height={externalImageDimensions ? externalImageDimensions.height : undefined}
					/>
				)}
			</div>
			<Caption richTexts={block.NImage.Caption} block={block} as="figcaption" />
		</figure>
	)
}
