---
import { Image } from "astro:assets";
import { type Post } from "@/lib/interfaces.ts";
import { getPostByPageId } from "@/lib/notion/client";
import {
	resolvePostHref,
	getNotionImage,
	getImageComponentFormat,
	isExternalPost,
} from "@/lib/blog-helpers.ts";
import { MENU_PAGES_COLLECTION } from "@/constants";
import { getIconTailwindFilterStyle } from "@/utils/style-helpers";
import Icon from "@/components/ui/Icon.astro";
import { isNotionHostedIconUrl } from "@/lib/notion/client";

export interface Props {
	pageId: string;
}

const { pageId } = Astro.props;

let post: Post = null;
if (pageId) {
	post = await getPostByPageId(pageId);
}

const hreflink = post ? resolvePostHref(post) : null;
const external = isExternalPost(post);

let downloadedIcon = null;
let externalIconPath = null;

if (!external && post?.Icon && post.Icon.Url) {
	const iconUrl = post.Icon.Url;
	const isNotionIcon = isNotionHostedIconUrl(iconUrl);
	const canBeCachedLocally =
		post.Icon.Type === "file" || post.Icon.Type === "custom_emoji" || isNotionIcon;

	if (canBeCachedLocally) {
		downloadedIcon = await getNotionImage(new URL(iconUrl));
	}

	if (!downloadedIcon) {
		// Prefer local, but fall back to the remote URL if the asset wasn't found in `src/assets/notion`.
		externalIconPath = iconUrl;
	}
}
---

{
	post && (
		<a
			href={hreflink}
			class="site-page-link text-link inline items-center justify-center"
			target={external ? "_blank" : undefined}
			rel={external ? "nofollow noopener" : undefined}
		>
			<>
				{external ? (
					<span class="mr-1 inline">
						<Icon
							name={"external-link-mention"}
							class="text-accent/80 inline h-4 w-4 align-sub"
							aria-hidden="true"
						/>
					</span>
				) : (
					<span class="mr-1 inline">
						{post.Icon && post.Icon.Type === "emoji" ? (
							post.Icon.Emoji
						) : post.Icon &&
						  (post.Icon.Type === "external" ||
								post.Icon.Type === "file" ||
								post.Icon.Type === "custom_emoji") ? (
							downloadedIcon ? (
								<Image
									src={downloadedIcon}
									class={`no-rss inline h-4 w-4 shrink-0 align-sub ${getIconTailwindFilterStyle(post.Icon.Url)}`}
									widths={[100]}
									sizes="40px"
									alt=""
									format={getImageComponentFormat(downloadedIcon)}
								/>
							) : (
								<img
									src={externalIconPath}
									class={`no-rss inline h-4 w-4 shrink-0 align-sub ${getIconTailwindFilterStyle(post.Icon.Url)}`}
									alt=""
								/>
							)
						) : (
							<Icon name={"document"} class="inline h-4 w-4 align-sub" aria-hidden="true" />
						)}
					</span>
				)}
				<span class="inline w-full">
					{post.Title}
					{external && <span class="sr-only">External link</span>}
				</span>
			</>
		</a>
	)
}
