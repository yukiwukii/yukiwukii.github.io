---
import { Image } from "astro:assets";
import * as interfaces from "@/lib/interfaces.ts";
import { getNotionColorToTailwindColor, getIconTailwindFilterStyle } from "@/utils/style-helpers";
import { getNotionImage, getImageComponentFormat } from "@/lib/blog-helpers.ts";
import { isNotionHostedIconUrl } from "@/lib/notion/client";
import RichText from "@/components/notion-blocks/RichText.astro";
import NotionBlocks from "@/components/NotionBlocks.astro";

export interface Props {
	block: interfaces.Block;
	renderChildren?: boolean; // Make this optional
	setId?: boolean;
}

const { block, renderChildren = true, setId = true } = Astro.props;
const hasRichTexts = block.Callout && block.Callout.RichTexts && block.Callout.RichTexts.length > 0;

let externalIconPath = null;
let downloadedIcon = null;

if (block.Callout?.Icon && block.Callout.Icon.Url) {
	const iconUrl = block.Callout.Icon.Url;
	const isNotionIcon = isNotionHostedIconUrl(iconUrl);
	const canBeCachedLocally =
		block.Callout.Icon.Type === "file" ||
		block.Callout.Icon.Type === "custom_emoji" ||
		isNotionIcon;

	if (canBeCachedLocally) {
		downloadedIcon = await getNotionImage(new URL(iconUrl));
	}

	if (!downloadedIcon) {
		// For Notion-hosted icons we still prefer local, but fall back to the remote URL if the asset
		// wasn't found in `src/assets/notion` for any reason.
		externalIconPath = iconUrl;
	}
}
---

<div
	class={`
    callout
    ${
			block.Callout.Color === "default"
				? getNotionColorToTailwindColor(block.Callout.Color + "-background")
				: getNotionColorToTailwindColor(block.Callout.Color)
		}
  `}
	id={setId ? block.Id : undefined}
>
	{
		block.Callout && block.Callout.Icon && (
			<div class="callout-icon">
				{block.Callout.Icon.Type === "emoji" ? (
					block.Callout.Icon.Emoji
				) : block.Callout.Icon.Type === "external" ||
				  block.Callout.Icon.Type === "file" ||
				  block.Callout.Icon.Type === "custom_emoji" ? (
					downloadedIcon ? (
						<Image
							src={downloadedIcon}
							class={`no-rss h-5 w-5 max-w-none ${getIconTailwindFilterStyle(block.Callout.Icon.Url)}`}
							widths={[100]}
							sizes="40px"
							alt=""
							format={getImageComponentFormat(downloadedIcon)}
						/>
					) : (
						<img
							src={externalIconPath}
							class={`no-rss h-5 w-5 max-w-none ${getIconTailwindFilterStyle(block.Callout.Icon.Url)}`}
							alt=""
						/>
					)
				) : null}
			</div>
		)
	}
	<div class={`callout-content ${!hasRichTexts ? "simple" : ""}`}>
		{
			hasRichTexts &&
				block.Callout.RichTexts.map((richText: interfaces.RichText) => (
					<RichText richText={richText} blockID={block.Id} block={block} />
				))
		}
		{
			block.Callout.Children && renderChildren && (
				<NotionBlocks
					blocks={block.Callout.Children}
					renderChildren={renderChildren}
					setId={setId}
				/>
			)
		}
	</div>
</div>
