---
import type { SiteMeta } from "@/types";
import "@/styles";
import { Font } from "astro:assets";
import { siteInfo } from "@/siteInfo";
import {
	ENABLE_LIGHTBOX,
	TRACKING,
	THEME,
	GOOGLE_SEARCH_CONSOLE_META_TAG,
	GISCUS,
} from "@/constants";
import { HOME_PAGE_SLUG } from "@/constants";
import { getNavLink } from "@/lib/blog-helpers";

type Props = SiteMeta;

const { title, description, ogImage, articleDate, author } = Astro.props;

const titleSeparator = "â€¢";
const siteTitle = `${title} ${titleSeparator} ${siteInfo.title}`;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(
	getNavLink(ogImage ? ogImage : `/og-image/${HOME_PAGE_SLUG}.png`),
	Astro.url,
).href;
const faviconLink = getNavLink("/favicon.ico");
const isBuildOrPreviewMode = import.meta.env.MODE === "production";
// Use provided author or fallback to site author
const metaAuthor = author || siteInfo.author;
const publicGaTrackingId =
	isBuildOrPreviewMode &&
	TRACKING &&
	Object.keys(TRACKING).length > 0 &&
	TRACKING["google-analytics"] &&
	Object.keys(TRACKING["google-analytics"]).length > 0 &&
	TRACKING["google-analytics"]["use-ga"] &&
	TRACKING["google-analytics"]["public-ga-tracking-id"]
		? TRACKING["google-analytics"]["public-ga-tracking-id"]
		: null;
const setUmami =
	isBuildOrPreviewMode &&
	TRACKING &&
	Object.keys(TRACKING).length > 0 &&
	TRACKING["umami"] &&
	Object.keys(TRACKING["umami"]).length > 0 &&
	TRACKING["umami"]["use-umami"] &&
	TRACKING["umami"]["data-website-id"];
const umamiDataWebsiteId = setUmami ? TRACKING["umami"]["data-website-id"] : null;
const umamiSrc = isBuildOrPreviewMode
	? setUmami && TRACKING["umami"]["self-hosted"] && TRACKING["umami"]["self-hosted-umami-url"]
		? TRACKING["umami"]["self-hosted-umami-url"]
		: "https://cloud.umami.is/script.js"
	: null;

const useGiscus =
	GISCUS &&
	Object.keys(GISCUS).length > 0 &&
	GISCUS["data-repo"] &&
	GISCUS["data-repo-id"] &&
	GISCUS["data-category"] &&
	GISCUS["data-category-id"];
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />

{/* Preconnect to external CDN resources for faster loading */}
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
{/*Preconnect ti giscus for faster loading */}
{useGiscus && <link rel="preconnect" href="https://giscus.app" crossorigin />}

{/* Astro Fonts - served locally from your domain */}
{
	THEME?.["fontfamily-google-fonts"] && (
		<>
			{(THEME["fontfamily-google-fonts"]["sans-font-name"] ||
				THEME["fontfamily-google-fonts"]["mono-font-name"]) && (
				<Font
					cssVariable="--font-sans"
					preload={[
						{ weight: 400, style: "normal" },
						{ weight: 600, style: "normal" },
						{ weight: 700, style: "normal" },
					]}
				/>
			)}
			{THEME["fontfamily-google-fonts"]["mono-font-name"] && (
				<Font cssVariable="--font-mono" preload={[{ weight: 400, style: "normal" }]} />
			)}
		</>
	)
}
{
	ENABLE_LIGHTBOX && (
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css"
			media="print"
			onload="this.media='all'"
		/>
	)
}
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>{siteTitle}</title>

{/* Icons / Favicon */}
<link rel="icon" href={faviconLink} sizes="any" />
<link rel="canonical" href={canonicalURL} />

{/* Primary Meta Tags */}
<meta name="title" content={siteTitle} />
<meta name="description" content={description} />
<meta name="author" content={metaAuthor} />

{/* Theme Colour */}
<meta name="theme-color" content="" />

{/* Open Graph / Facebook */}
<meta property="og:type" content={articleDate ? "article" : "website"} />
<meta property="og:title" content={siteTitle} />
<meta property="og:description" content={description} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:site_name" content={siteInfo.title} />
<meta property="og:locale" content={siteInfo.ogLocale} />
{
	ogImage && (
		<>
			<meta property="og:image" content={socialImageURL} />
			<meta property="og:image:width" content="1200" />
			<meta property="og:image:height" content="630" />
		</>
	)
}

{
	articleDate && (
		<>
			<meta property="article:author" content={metaAuthor} />
			<meta property="article:published_time" content={articleDate} />
		</>
	)
}

{/* Twitter */}
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalURL} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
{
	GOOGLE_SEARCH_CONSOLE_META_TAG && (
		<meta name="google-site-verification" content={GOOGLE_SEARCH_CONSOLE_META_TAG} />
	)
}
{ogImage && <meta property="twitter:image" content={socialImageURL} />}

{/* Sitemap */}
<link rel="sitemap" href="/sitemap-index.xml" />

{/* Katex */}
<link
	rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex-swap.min.css"
	integrity="sha384-TmCphkQRJZ6h5e3VPBmWxyG5KVl/1N27oPYDX+Qsu0H8tPq7vHsJphjzvK9Gxwls"
	crossorigin="anonymous"
	media="print"
	onload="this.media='all'"
/>

{/* RSS auto-discovery */}
<link
	rel="alternate"
	type="application/rss+xml"
	title={siteInfo.title}
	href={getNavLink("/rss.xml")}
/>

{/* Webmentions */}
{
	siteInfo.webmentions && Object.keys(siteInfo.webmentions).length > 0 && (
		<>
			<link rel="webmention" href={siteInfo.webmentions.link} />
			{siteInfo.webmentions.pingback && (
				<link rel="pingback" href={siteInfo.webmentions.pingback} />
			)}
		</>
	)
}
<script
	is:inline
	src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js"
	crossorigin="anonymous"
	async=""></script>

{
	publicGaTrackingId && (
		<>
			<script
				type="text/partytown"
				src={`https://www.googletagmanager.com/gtag/js?id=${publicGaTrackingId}`}
				defer
			/>
			<script type="text/partytown" define:vars={{ publicGaTrackingId }} defer>
				window.dataLayer = window.dataLayer || [];
				function gtag() {
					dataLayer.push(arguments);
				}
				gtag("js", new Date());
				gtag("config", publicGaTrackingId);
			</script>
		</>
	)
}
{
	setUmami && (
		<script
			type="text/partytown"
			data-astro-rerun
			src={umamiSrc}
			data-website-id={umamiDataWebsiteId}
			defer
		/>
	)
}
<style>
	@view-transition {
		navigation: auto;
	}
</style>
