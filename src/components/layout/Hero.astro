---
import FormattedDate from "@/components/ui/FormattedDate.astro";
import AuthorByline from "@/components/layout/AuthorByline.astro";
import type { Post } from "@/lib/interfaces";
import { getNotionColorToTailwindColor } from "@/utils/style-helpers";
import { areDifferentDates } from "@/utils/date";
import { getNavLink, getNotionImage, getImageComponentFormat } from "@/lib/blog-helpers";
import Icon from "@/components/ui/Icon.astro";
import { slugify } from "@/utils";
import { getImage } from "astro:assets";
import { COVER_AS_HERO_BACKGROUND_ENABLED } from "@/constants";
import HeroBackgroundCover from "@/components/layout/HeroBackgroundCover.astro";

interface Props {
	post: Post;
}

const { post } = Astro.props;

const dateTimeOptions: Intl.DateTimeFormatOptions = {
	month: "long",
};

// Check if we should show cover as hero background
const hasCover = post.Cover && post.Cover.Url;
const showHeroBackground = COVER_AS_HERO_BACKGROUND_ENABLED && hasCover;

// Get optimized cover image URL for background (use same pipeline as Notion images)
let coverImageUrl = "";
let coverPlaceholderUrl = "";
if (showHeroBackground && post.Cover?.Url) {
	try {
		const coverUrl = new URL(post.Cover.Url);
		const downloadedImage = await getNotionImage(coverUrl);

		if (downloadedImage) {
			// Let Astro generate an optimized version; fall back to original metadata src
			const optimized = await getImage({
				src: downloadedImage,
				format: getImageComponentFormat(downloadedImage),
				quality: 65,
				width: downloadedImage.width > 2100 ? 2100 : downloadedImage.width,
			});
			coverImageUrl = optimized?.src || downloadedImage.src;

			try {
				const tiny = await getImage({
					src: downloadedImage,
					format: getImageComponentFormat(downloadedImage),
					quality: 5,
					width: downloadedImage.width > 2100 ? 2100 : downloadedImage.width,
				});
				coverPlaceholderUrl = tiny?.src || coverImageUrl;
			} catch {
				coverPlaceholderUrl = coverImageUrl;
			}
		} else {
			coverImageUrl = post.Cover.Url;
			coverPlaceholderUrl = post.Cover.Url;
		}
	} catch {
		coverImageUrl = post.Cover.Url;
		coverPlaceholderUrl = post.Cover?.Url || "";
	}
}
---

{
	showHeroBackground && coverPlaceholderUrl && (
		<link rel="preload" as="image" href={coverPlaceholderUrl} fetchpriority="high" />
	)
}

<HeroBackgroundCover
	enableBackground={showHeroBackground}
	backgroundUrl={coverImageUrl}
	placeholderUrl={coverPlaceholderUrl}
	class="mb-4"
>
	<h1
		class="title mb-3 sm:mb-1"
		data-pagefind-filter=`collections:${post.Collection}`
		data-pagefind-weight="10"
	>
		{post.Title}
	</h1>
	{post.Excerpt && <q class="mb-2 block italic">{post.Excerpt}</q>}
	{post.Authors !== undefined && <AuthorByline authors={post.Authors} class="mb-2" />}
	<div class="flex max-w-full flex-wrap items-center gap-x-3 gap-y-2">
		<p class="font-semibold">
			<FormattedDate date={new Date(post.Date)} dateTimeOptions={dateTimeOptions} />
		</p>
		{
			post.Date && post.LastUpdatedDate && areDifferentDates(post.Date, post.LastUpdatedDate) && (
				<span class="bg-quote/10 text-quote rounded-lg p-1">
					{"Last Updated:"}
					<FormattedDate
						class="ms-1"
						date={new Date(post.LastUpdatedDate)}
						dateTimeOptions={dateTimeOptions}
					/>
				</span>
			)
		}
	</div>
	{
		post.Tags && post.Tags.length > 0 && (
			<div class="mt-2">
				<Icon
					class="me-1 inline-block h-4 w-4"
					name={"tag-outline"}
					aria-hidden="true"
					focusable="false"
				/>
				{post.Tags.map((tag, i) => (
					<>
						<a
							class={`mt-1 inline-block rounded-lg px-2 ${getNotionColorToTailwindColor(
								tag.color + "-background",
								true,
							)}`}
							aria-label={`View more blogs with the tag ${tag.name}`}
							href={getNavLink("/tags/" + slugify(tag.name) + "/")}
							data-pagefind-filter="tags"
						>
							{tag.name}
						</a>{" "}
					</>
				))}
			</div>
		)
	}
</HeroBackgroundCover>
<hr class="divider bg-accent/30 mx-auto my-4 h-1 w-full rounded-sm border-none" />
